# Package Dependency Management

We use [Poetry](https://python-poetry.org/docs/) for managing our APIs dependencies.

The [pyproject.toml](../../api/pyproject.toml) file is where we configure the minimum or exact version of a dependency. These versions also get modified
by the poetry commands (several described below) which can help generate / find the proper versions for a dependency.

From this configuration, a [poetry.lock](../../api/poetry.lock) is generated which has the specific references to dependencies to be downloaded. The lock
file should never be manually modified and should always be generated by Poetry.

# General Information

## Dependency Versions

In our dependencies we could specify a package version as `1.2.0` or `^1.2.0` which each have specific semantic meaning (in this case, exactly `1.2.0` or `>=1.2.0 and <2.0.0`).

See [version constraints](https://python-poetry.org/docs/dependency-specification/#version-constraints) for further details.

## Package Extras

Some dependencies have "extra" packages that can be downloaded in addition to the main package for additional optional features.
These can be specified in the `pyproject.toml` file like so: `marshmallow-dataclass = {extras = ["enum", "union"], version = "^8.5.8"}` where
each "extra" is a string in the extras list.

## Dev Dependencies

We split dependencies into dev and non-dev dependencies. Dev dependencies are ONLY installed locally and in some CI/CD commands as they are only necessary for local development (including tests, linting, formatting, and dev utilities).

Many of our dev tools are used for testing, including generating data which we want to explicitly avoid doing non-locally.
Doing this also reduces the image size, and improves security as there are fewer dependencies that could potentially run on a production server.

Dependencies are grouped under `tool.poetry.dependencies` and `tool.poetry.group.dev.dependencies`. When adding a dependency,
make sure to put it in the proper group as when the API runs non-locally it will only have  packages from the first group.

# Common Commands

See the Poetry docs for more details, but here are a few useful commands for managing package dependencies in common scenarios.

## Installing

Installing is only necessary if you're running outside of Docker (eg. you've set the `PY_RUN_APPROACH=local` env variable)

```shell
poetry install --no-root --all-extras --with dev
```

If you want to make sure any extra packages are cleaned up that you may have previously installed:

```shell
poetry install --no-root --all-extras --with dev --sync
```

## Adding a dependency or updating minimum version

Adding a dependency of at least a specific version or changing the minimum version can be done with the [add](https://python-poetry.org/docs/cli/#add) command which will update the `pyproject.toml` file for you.

```shell
poetry add alembic@^1.12.0

# Depending on your shell, you may need to escape ^ like so
poetry add alembic@\^1.12.0
```

Adding a dev dependency
```shell
poetry add mypy --group dev
```

Updating the minimum version to the latest minor (major.minor.patch semver) version
```shell
poetry add mypy@latest --group dev

# If it was currently ~1.6.1 and the latest was 1.8.0, then it would change to ~1.8.0
```

## Update dependencies to latest / update poetry.lock

[poetry update](https://python-poetry.org/docs/cli/#update) will update the poetry.lock file following the rules from the pyproject.toml file.

```shell
poetry update

# Or for a specific package
poetry update mypy
```

Note that if this isn't updating your package (Poetry is saying `No dependencies to install or update`) make sure
the package version you want to upgrade to is allowed by the configuration in the pyproject.toml file.

## Update Poetry itself

As I always lose [the command](https://python-poetry.org/docs/cli/#self-update), for your convenience:
```shell
poetry self update
```

# Verification

At a minimum, all of our formatting, linting, and tests should continue working when upgrading. If a dependency upgrade causes failures
it will need to be investigated and fixed either by adjusting the code using it (eg. a method signature in a dependency changed) or adjusting
the version we use.

Locally it is suggested you run the following commands after upgrading to verify the API still runs:
```shell
# Stop and delete DB volumes so it will be made fresh
make clean-volumes

# Rebuild
make init

# Optionally if running outside of the docker container
poetry install --no-root --all-extras --with dev --sync

# format / lint / test
make check

# Run the API and verify it locally at http://localhost:8080/docs
make run-logs
```

## Specific dependency details

Our primary dependencies that we should take note of when they are upgraded (with links to their change logs).

* [black](https://black.readthedocs.io/en/stable/change_log.html) / [flake8](https://flake8.pycqa.org/en/latest/release-notes/index.html) / [isort](https://pycqa.github.io/isort/CHANGELOG.html) / [mypy](https://mypy-lang.org/news.html) - I suggest running `make format lint` after upgrading these and seeing if any files change / any issues are flagged as rules may have changed.
* [APIFlask](https://apiflask.com/changelog/) - Running tests should verify everything is still connected properly, but you should also verify the OpenAPI docs are the same by running `make run-logs` and going to http://localhost:8080/docs
* [SQLAlchemy](https://docs.sqlalchemy.org/en/latest/changelog/)
* [Alembic](https://alembic.sqlalchemy.org/en/latest/changelog.html)
* [Pydantic](https://docs.pydantic.dev/latest/changelog/)
* [Marshmallow](https://marshmallow.readthedocs.io/en/stable/changelog.html)
* [psycopg](https://www.psycopg.org/psycopg3/docs/news.html)

# Upgrading Python
Python does [yearly releases](https://devguide.python.org/versions/) for their minor versions (eg. 3.12 -> 3.13). They do not
use semvar versioning, and their [minor releases](https://devguide.python.org/developer-workflow/development-cycle/#devcycle) contain
breaking changes.

Pin to a specific minor version of python just in case anything would break when the yearly release does occur.
Only pin the minor versions of Python (eg. 3.12), and not the patch versions (eg. 3.12.1) as those contain bug and security fixes.

Along with any version upgrades, remember to:
- Test the system functionality before deploying to production
- Review the [changelog](https://docs.python.org/3/whatsnew/changelog.html)
for any breaking changes of features you may use

## Upgrade Steps
To upgrade the Python version, make changes in the following places:
1. Local Python version (see more about managing local Python versions in [development](./development.md))
2. [Dockerfile](/api/Dockerfile)
    search for the line `FROM python:3.12-slim as base` - supported versions can be found on [Dockerhub](https://hub.docker.com/_/python)
3. [pyproject.toml](/api/pyproject.toml)
    search for the line
    ```toml
    [tool.poetry.dependencies]
    python = "~3.12"
    ```
   Then run `poetry lock --no-update` to update the [poetry.lock](/api/poetry.lock) file.